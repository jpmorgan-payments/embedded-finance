import { Meta } from '@storybook/addon-docs/blocks';
import { Mermaid } from '../../../../.storybook/Mermaid';

<Meta title="Core/LinkedAccountWidget/Interactive Workflows/State Machine" />

# Linked Account State Machine

This document describes the state transitions for linked bank accounts (recipients) in the Embedded Payments API.

## Status Overview

The following statuses are defined for linked accounts:

- **ACTIVE** - Account is verified and ready for transactions
- **INACTIVE** - Account has been deactivated and cannot be used
- **MICRODEPOSITS_INITIATED** - Microdeposit verification process has started (pending verification)
- **READY_FOR_VALIDATION** - Microdeposits sent, waiting for user to verify amounts (action required)
- **REJECTED** - Account verification failed or was rejected
- **PENDING** - Account information is being processed

## State Diagram

<Mermaid>
  {`
stateDiagram-v2
    [*] --> AutomatedVerification: Account Creation
    
    AutomatedVerification --> ACTIVE: Instant Success
    AutomatedVerification --> MICRODEPOSITS_INITIATED: Microdeposit Required
    AutomatedVerification --> REJECTED: Failed
    AutomatedVerification --> PENDING: Split Profile
    
    PENDING --> ACTIVE: Second Attempt Success
    PENDING --> MICRODEPOSITS_INITIATED: Second Attempt Requires MD
    PENDING --> REJECTED: Second Attempt Failed
    
    MICRODEPOSITS_INITIATED --> READY_FOR_VALIDATION: MD Sent
    MICRODEPOSITS_INITIATED --> REJECTED: MD Send Failed
    MICRODEPOSITS_INITIATED --> INACTIVE: Expired (21 days)
    
    READY_FOR_VALIDATION --> ACTIVE: Verified
    READY_FOR_VALIDATION --> REJECTED: Max Attempts (3)
    READY_FOR_VALIDATION --> INACTIVE: Expired (20 business days)
    
    ACTIVE --> [*]
    REJECTED --> [*]
    INACTIVE --> [*]
    
    note right of PENDING
        Used in split profile scenarios where
        initial automated verification requires
        a second attempt
    end note
`}
</Mermaid>

## Status Transition Chains

### 1. Instant Verification (Happy Path)

**Chain:** `START → ACTIVE`

**Description:** Account verification succeeds immediately through automated verification. Both account verification and authentication pass on first attempt.

**User Experience:** Account is ready to use immediately after linking.

---

### 2. Microdeposit Verification Success

**Chain:** `START → MICRODEPOSITS_INITIATED → READY_FOR_VALIDATION → ACTIVE`

**Description:** Standard microdeposit verification flow. Two small deposits are sent to the user's bank account. User verifies ownership by entering the exact amounts.

**User Experience:**

1. Account link initiated
2. User waits 3-5 business days for deposits to arrive
3. User enters the two deposit amounts
4. Account becomes active upon successful verification

---

### 3. Microdeposit Verification Failed

**Chain:** `START → MICRODEPOSITS_INITIATED → READY_FOR_VALIDATION → REJECTED`

**Description:** User exhausts all verification attempts (typically 3) by entering incorrect microdeposit amounts.

**User Experience:** User must re-link the account and start verification process over.

---

### 4. Microdeposit Send Failure

**Chain:** `START → MICRODEPOSITS_INITIATED → REJECTED`

**Description:** System unable to send microdeposits to the bank account (e.g., invalid account, bank rejection).

**User Experience:** Immediate failure notification, user must correct account information and retry.

---

### 5. Microdeposit Expiration (Initiated Phase)

**Chain:** `START → MICRODEPOSITS_INITIATED → INACTIVE`

**Description:** Microdeposit process expires before deposits are successfully sent (21-day timeout).

**User Experience:** Account link expires if deposits aren't sent within timeframe.

---

### 6. Microdeposit Expiration (Validation Phase)

**Chain:** `START → MICRODEPOSITS_INITIATED → READY_FOR_VALIDATION → INACTIVE`

**Description:** User doesn't verify microdeposits within 20 business days of deposits being sent.

**User Experience:** Account link expires, user must re-link account to try again.

---

### 7. Split Profile Pending Flow (Success)

**Chain:** `START → PENDING → ACTIVE`

**Description:** Special case where automated verification returns pending status codes. A second verification attempt resolves to active status.

**User Experience:** Brief "processing" state before account becomes active.

---

### 8. Split Profile Pending to Microdeposits

**Chain:** `START → PENDING → MICRODEPOSITS_INITIATED → READY_FOR_VALIDATION → ACTIVE`

**Description:** Initial automated verification returns pending, second attempt requires microdeposit verification.

**User Experience:** Starts as pending, then falls into standard microdeposit flow.

---

### 9. Split Profile Pending to Rejection

**Chain:** `START → PENDING → REJECTED`

**Description:** Initial automated verification returns pending, second attempt fails verification.

**User Experience:** Account temporarily shows as processing, then fails.

---

### 10. Immediate Verification Rejection

**Chain:** `START → REJECTED`

**Description:** Automated verification immediately rejects account due to validation failures (invalid account number, routing number, etc.).

**User Experience:** Immediate failure with error message indicating what needs to be corrected.

---

### 11. Verification Retry Flow (Success)

**Chain:** `START → REJECTED → ACTIVE`

**Description:** Automated verification retry allows retry of verification, which succeeds on second attempt.

**User Experience:** Initial failure, automatic retry succeeds.

---

### 12. Verification Retry to Microdeposits

**Chain:** `START → REJECTED → MICRODEPOSITS_INITIATED → READY_FOR_VALIDATION → ACTIVE`

**Description:** Automated verification retry falls back to microdeposit verification.

**User Experience:** Initial failure, then automatic fallback to microdeposit flow.

---

## Terminal States

**Final Success States:**

- **ACTIVE** - Account fully verified and operational

**Final Failure States:**

- **REJECTED** - Verification failed, cannot be recovered
- **INACTIVE** - Expired or deactivated, requires re-linking

## Important Notes

- **Expiration Window:** Microdeposit verification must be completed within 20 business days from when deposits are sent
- **Max Attempts:** Users have 3 total attempts to verify microdeposit amounts
- **Retry Logic:** Some error conditions allow automatic verification retry
- **PENDING Status:** Used in split profile scenarios where automated verification returns pending codes, requiring a second verification attempt

## Testing These Flows

The workflow stories in this section demonstrate these state transitions:

- **LinkNewAccount** - Default microdeposit flow (MICRODEPOSITS_INITIATED)
- **LinkNewAccountActive** - Instant verification (ACTIVE)
- **LinkNewAccountPending** - Split profile pending flow (PENDING)
- **LinkNewAccountRejected** - Immediate rejection (REJECTED)
- **LinkNewAccountInactive** - Expired/deactivated (INACTIVE)
- **SuccessfulVerification** - Complete microdeposit verification
- **FailedVerification** - Incorrect amounts entered
- **MaxAttemptsExceeded** - All verification attempts used
- **RtpUnavailableAtBank** - RTP payment method not supported at bank

## Payment Method Availability

### RTP (Real-Time Payments) Unavailability

Not all financial institutions support RTP (Real-Time Payments). When a user attempts to link an account with RTP enabled, but the bank associated with the routing number doesn't support RTP transactions, the API will return an error.

**Error Response:**
```json
{
  "httpStatus": 400,
  "title": "Payment Method Not Supported",
  "context": [
    {
      "code": "RTP_UNAVAILABLE",
      "field": "account.routingInformation[].transactionType",
      "message": "RTP (Real-Time Payments) is not available at this financial institution."
    }
  ]
}
```

**User Experience:**
1. User selects RTP as a payment method when linking an account
2. User enters bank details (routing number, account number)
3. Upon submission, an error message is displayed explaining RTP is unavailable
4. User can deselect RTP and proceed with other payment methods (ACH, Wire)

**Recommended UI Handling:**
- Display a clear error message explaining RTP is not available at this bank
- Suggest the user deselect RTP and try again with other payment methods
- Do not prevent the user from completing the account linking with available methods

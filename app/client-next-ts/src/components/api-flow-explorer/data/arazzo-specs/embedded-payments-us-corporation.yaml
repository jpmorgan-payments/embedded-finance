arazzo: 1.0.0
info:
  title: Embedded Payments US Corporation Onboarding Workflow
  summary: Complete onboarding workflow for US-based Corporations
  description: |
    This workflow defines the complete onboarding process for US-based Corporations
    using Embedded Payments services. It includes additional board resolution verification
    required for corporate entities.
  version: 1.0.0

sourceDescriptions:
  - name: embedded-finance-api
    url: /api-specs/embedded-finance-pub-smbdo-1.0.16.yaml
    type: openapi

workflows:
  - workflowId: embedded-payments-us-corporation-onboarding
    info:
      title: US Corporation Embedded Payments Onboarding
      description: Complete onboarding workflow for US Corporation entities
    steps:
      - stepId: create-client
        description: Create a new client record in the system
        operationId: createClient
        parameters:
          - name: Content-Type
            in: header
            value: application/json
        requestBody:
          contentType: application/json
          payload:
            clientType: BUSINESS
            businessInfo:
              legalEntityType: CORPORATION
              jurisdiction: US
        successCriteria:
          - condition: $statusCode == 201
          - condition: $response.body.clientId != null
        onSuccess:
          - stepId: submit-business-information
        onFailure:
          - stepId: handle-client-creation-error

      - stepId: submit-business-information
        description: Submit detailed business information for the Corporation
        operationId: submitBusinessInformation
        parameters:
          - name: clientId
            in: path
            value: $steps.create-client.outputs.clientId
        requestBody:
          contentType: application/json
          payload:
            businessName: $inputs.businessName
            dbaName: $inputs.dbaName
            businessAddress:
              street: $inputs.businessAddress.street
              city: $inputs.businessAddress.city
              state: $inputs.businessAddress.state
              postalCode: $inputs.businessAddress.postalCode
              country: US
            taxId: $inputs.taxId
            businessType: CORPORATION
            industryCode: $inputs.industryCode
            businessDescription: $inputs.businessDescription
            website: $inputs.website
            phoneNumber: $inputs.phoneNumber
            email: $inputs.email
            incorporationDate: $inputs.incorporationDate
            stateOfIncorporation: $inputs.stateOfIncorporation
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.body.status == "SUBMITTED"
        onSuccess:
          - stepId: upload-documents
        onFailure:
          - stepId: handle-business-info-error

      - stepId: upload-documents
        description:
          Upload required business documents for Corporation verification
        operationId: uploadDocuments
        parameters:
          - name: clientId
            in: path
            value: $steps.create-client.outputs.clientId
        requestBody:
          contentType: multipart/form-data
          payload:
            documentType: ARTICLES_OF_INCORPORATION
            file: $inputs.articlesOfIncorporation
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.body.documentId != null
        onSuccess:
          - stepId: verify-business-owners
        onFailure:
          - stepId: handle-document-upload-error

      - stepId: verify-business-owners
        description: Submit business owner/officer information for verification
        operationId: verifyBusinessOwners
        parameters:
          - name: clientId
            in: path
            value: $steps.create-client.outputs.clientId
        requestBody:
          contentType: application/json
          payload:
            owners:
              - firstName: $inputs.owner.firstName
                lastName: $inputs.owner.lastName
                dateOfBirth: $inputs.owner.dateOfBirth
                ssn: $inputs.owner.ssn
                address:
                  street: $inputs.owner.address.street
                  city: $inputs.owner.address.city
                  state: $inputs.owner.address.state
                  postalCode: $inputs.owner.address.postalCode
                  country: US
                ownershipPercentage: $inputs.owner.ownershipPercentage
                title: $inputs.owner.title
                isOfficer: true
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.body.verificationStatus == "PENDING"
        onSuccess:
          - stepId: verify-board-resolution
        onFailure:
          - stepId: handle-owner-verification-error

      - stepId: verify-board-resolution
        description:
          Verify board resolution authorizing the business relationship
        operationId: verifyBoardResolution
        parameters:
          - name: clientId
            in: path
            value: $steps.create-client.outputs.clientId
        requestBody:
          contentType: multipart/form-data
          payload:
            documentType: BOARD_RESOLUTION
            file: $inputs.boardResolution
            resolutionDate: $inputs.resolutionDate
            authorizedSignatory: $inputs.authorizedSignatory
        successCriteria:
          - condition: $statusCode == 200
          - condition: $response.body.verificationStatus == "APPROVED"
        onSuccess:
          - stepId: setup-payment-account
        onFailure:
          - stepId: handle-board-resolution-error

      - stepId: setup-payment-account
        description: Set up the payment account for the verified Corporation
        operationId: setupPaymentAccount
        parameters:
          - name: clientId
            in: path
            value: $steps.create-client.outputs.clientId
        requestBody:
          contentType: application/json
          payload:
            accountType: BUSINESS_CHECKING
            bankingInfo:
              routingNumber: $inputs.bankingInfo.routingNumber
              accountNumber: $inputs.bankingInfo.accountNumber
              accountHolderName: $inputs.businessName
        successCriteria:
          - condition: $statusCode == 201
          - condition: $response.body.accountId != null
          - condition: $response.body.status == "ACTIVE"
        onSuccess:
          - stepId: onboarding-complete
        onFailure:
          - stepId: handle-payment-setup-error

      - stepId: onboarding-complete
        description: Onboarding process completed successfully
        operationId: notifyOnboardingComplete
        parameters:
          - name: clientId
            in: path
            value: $steps.create-client.outputs.clientId
        successCriteria:
          - condition: $statusCode == 200

      # Error handling steps
      - stepId: handle-client-creation-error
        description: Handle client creation errors
        operationId: logError
        parameters:
          - name: errorType
            in: query
            value: CLIENT_CREATION_FAILED

      - stepId: handle-business-info-error
        description: Handle business information submission errors
        operationId: logError
        parameters:
          - name: errorType
            in: query
            value: BUSINESS_INFO_FAILED

      - stepId: handle-document-upload-error
        description: Handle document upload errors
        operationId: logError
        parameters:
          - name: errorType
            in: query
            value: DOCUMENT_UPLOAD_FAILED

      - stepId: handle-owner-verification-error
        description: Handle business owner verification errors
        operationId: logError
        parameters:
          - name: errorType
            in: query
            value: OWNER_VERIFICATION_FAILED

      - stepId: handle-board-resolution-error
        description: Handle board resolution verification errors
        operationId: logError
        parameters:
          - name: errorType
            in: query
            value: BOARD_RESOLUTION_FAILED

      - stepId: handle-payment-setup-error
        description: Handle payment account setup errors
        operationId: logError
        parameters:
          - name: errorType
            in: query
            value: PAYMENT_SETUP_FAILED
